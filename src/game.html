<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Canvas</title>
    <style>
      canvas {
        border: 1px solid #000;
      }
      .center {
        border: 5px solid;
        margin: auto;
        width: 50%;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <a
      href="https://prod.liveshare.vsengsaas.visualstudio.com/join?6E95FE330476CDDE0434A84B835DC8E48CB5"
      >liveshare</a
    >
    <div style="center;">
      <canvas id="canvas" width="700" height="700"></canvas>
    </div>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      const socket = new WebSocket("ws://192.168.0.14:8080");

      // Initial square position
      let x = 50;
      let y = 50;
      let playerId;

      // socket.send(JSON.stringify({ user_id: playerId, x, y }));

      const players = {};

      // Function to draw the square with a unique color for each user
      function drawSquare(user_id, x, y, color) {
        ctx.fillStyle = color;
        // ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillRect(x, y, 50, 50);
      }
      // Function to draw Pigs
      // user_id = "0" / <-- this is the wolf
      // user_id = "blahblahblah" / <--- these are players
      function drawPig(image2Draw, x, y) {
        let pigImg = new Image();
        pigImg.src = image2Draw;
        ctx.drawImage(pigImg, x, y);
      }
      // Send coordinates to the server when arrow keys are pressed
      document.addEventListener("keydown", (event) => {
        switch (event.key) {
          case "ArrowUp": {
            y -= 10;
            event.preventDefault();
            break;
          }
          case "ArrowDown": {
            event.preventDefault();
            y += 10;
            break;
          }
          case "ArrowLeft": {
            event.preventDefault();
            x -= 10;
            break;
          }
          case "ArrowRight": {
            event.preventDefault();
            x += 10;
            break;
          }
        }

        // drawSquare("blue"); // Use a unique color for each user

        // Send the updated coordinates to the server over WebSocket
        console.log("sending", { user_id: playerId, x, y });
        socket.send(JSON.stringify({ user_id: playerId, x, y }));
      });

      socket.addEventListener("message", (event) => {
        const data = JSON.parse(event.data);
        if (data.message === "new connection established") {
          console.log("initial connection", data);
          playerId = data.user_id;
          colorOfPlayer = data.color;
          imageOfPlayer = data.image;
          players[playerId] = {
            image: imageOfPlayer,
          };
          // Draw the initial square
          drawSquare(playerId, 50, 50, colorOfPlayer);
          drawPig(imageOfPlayer, 50, 50);
          // drawSquare("asdf", 90, 90);
        }

        if (data.message === "connection dropped") {
          console.log("connection dropped", data);
          delete players[data.user_id];
        }

        if (data.message === "player afk") {
          alert("your connection was dropped because you were afk");
          window.location.reload();
        }

        if (data.message === "you were eaten") {
          alert("You were eaten! you suck! Dismiss to try again");
          window.location.reload();
        }

        if (data.message === "other player was eaten") {
          delete players[data.user_id];
          return;
        }

        const { user_id, x, y, color, image, message } = data;
        console.log("got", user_id, x, y, color, image, message);
        const initialPlayer = players[user_id];
        const update = {
          x,
          y,
          color,
          image,
        };
        players[user_id] = { ...initialPlayer, ...update };

        // Draw the square for the received user
        console.log("players", players);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        Object.entries(players).forEach(([id, player]) => {
          drawSquare(id, player.x, player.y, player.color);
          drawPig(player.image, player.x, player.y);
        });
      });
    </script>
  </body>
</html>
